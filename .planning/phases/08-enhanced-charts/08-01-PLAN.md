---
phase: 08-enhanced-charts
type: execute
---

<objective>
Add MACC (Marginal Abatement Cost Curve) chart from Pareto data and carbon price sweep chart, wired into run.py alongside existing chart outputs.

Purpose: Provide the visual centerpieces for the "beyond the brief" stretch objective — MACC shows abatement cost structure, carbon sweep chart shows fleet sensitivity to carbon pricing.
Output: Two new chart functions in src/charts.py, wired into run.py so `--all` generates them automatically.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-shadow-prices-what-if/07-01-SUMMARY.md
@.planning/phases/06-submission-charts/06-02-SUMMARY.md

@src/charts.py
@src/sensitivity.py
@run.py

**Tech stack available:** PuLP, pandas, numpy, matplotlib (Agg backend)
**Established patterns:** All charts: Agg backend, 150 DPI, tight_layout(), plt.close(), os.makedirs for output dir
**Constraining decisions:**
- Phase 6: Charts use matplotlib Agg backend, tab10 colormap for fuel types, 150 DPI
- Phase 5: Pareto results include shadow_carbon_price between consecutive feasible points
- Phase 5: Carbon sweep returns fuel_type_counts per carbon price
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement MACC chart from Pareto frontier data</name>
  <files>src/charts.py</files>
  <action>
Add `plot_macc(pareto_results, output_path="outputs/charts/macc.png")` to src/charts.py.

MACC (Marginal Abatement Cost Curve) shows the cost of reducing emissions at each step along the Pareto frontier:
- X-axis: Cumulative CO2 reduction from base case (tonnes). Each bar's width = CO2 reduction at that Pareto step.
- Y-axis: Marginal abatement cost ($/tCO2eq) = shadow_carbon_price from run_pareto_sweep().
- Chart type: Horizontal step bars (waterfall-style). Each bar represents one Pareto step.
- Color: Bars colored by cost — green for cheap abatement, yellow for moderate, red for expensive. Use a gradient: bars below $100/t green, $100-$500 yellow, above $500 red.
- Reference line: Horizontal dashed line at $80/t (current CARBON_PRICE) labeled "Current carbon price ($80/t)".
- Filter: Only include feasible Pareto points that have a shadow_carbon_price (skip None and first point which has no shadow price).
- Labels: Title "Marginal Abatement Cost Curve", x-axis "Cumulative CO2eq Reduction (tonnes)", y-axis "Marginal Cost ($/tCO2eq)".
- Annotation: Label the total abatement potential (rightmost x value).

Follow existing chart pattern: Agg backend already set, figsize=(10, 6), 150 DPI, tight_layout, plt.close(fig).
  </action>
  <verify>
Run `python -c "from src.charts import plot_macc; print('import ok')"` — no import errors.
  </verify>
  <done>
plot_macc() renders MACC with step bars showing abatement cost structure, reference carbon price line, and color-coded bars.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement carbon price sweep chart</name>
  <files>src/charts.py</files>
  <action>
Add `plot_carbon_sweep(carbon_results, output_path="outputs/charts/carbon_price_sweep.png")` to src/charts.py.

Carbon price sweep chart — grouped bar chart comparing fleet metrics across carbon prices:
- X-axis: Carbon price labels ($80/t, $120/t, $160/t, $200/t).
- Two subplots stacked vertically (fig, (ax1, ax2)):
  - Top subplot: Total fleet cost (USD) as bars, one per carbon price. Color gradient from blue (low) to red (high).
  - Bottom subplot: Total CO2eq emissions (tonnes) as bars, one per carbon price. Color gradient from green (low CO2) to orange (high CO2).
- Mark infeasible carbon prices with "INFEASIBLE" text instead of bars.
- Title: "Fleet Sensitivity to Carbon Price".
- Grid lines on y-axis, alpha=0.3.

Follow existing chart pattern: figsize=(10, 8) for two subplots, 150 DPI, tight_layout, plt.close(fig).
  </action>
  <verify>
Run `python -c "from src.charts import plot_carbon_sweep; print('import ok')"` — no import errors.
  </verify>
  <done>
plot_carbon_sweep() renders dual-subplot chart showing cost and emissions sensitivity to carbon pricing.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire new charts into run.py</name>
  <files>run.py</files>
  <action>
Wire the two new chart functions into run.py:

1. Import plot_macc and plot_carbon_sweep from src.charts.

2. In the Pareto frontier section (after `chart_path = plot_pareto_frontier(pareto_results)`):
   - Add: `macc_path = plot_macc(pareto_results)`
   - Print: `f"MACC chart saved to: {macc_path}"`

3. In the carbon price sweep section (after printing fuel type composition):
   - Add: `carbon_chart_path = plot_carbon_sweep(carbon_results)`
   - Print: `f"Carbon price sweep chart saved to: {carbon_chart_path}"`

This means `--pareto` generates both the Pareto frontier and MACC charts, and `--carbon-sweep` generates the carbon price sweep chart. `--all` gets everything.
  </action>
  <verify>
Run `python run.py --all --cargo-demand 800000` — should generate all charts including MACC and carbon sweep. Check outputs/charts/ for new files.
  </verify>
  <done>
--all generates MACC and carbon sweep charts alongside existing charts. All 5 chart files in outputs/charts/: pareto_frontier.png, fleet_composition.png, safety_comparison.png, macc.png, carbon_price_sweep.png.
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `python run.py --all --cargo-demand 800000` runs without errors
- [ ] outputs/charts/macc.png exists and shows step bars with abatement costs
- [ ] outputs/charts/carbon_price_sweep.png exists and shows dual subplot
- [ ] All 5 chart files generated in outputs/charts/
- [ ] No import errors or warnings
</verification>

<success_criteria>

- All 3 tasks completed
- All verification checks pass
- No errors or warnings introduced
- MACC chart shows marginal abatement cost structure from Pareto data
- Carbon sweep chart shows fleet sensitivity to carbon pricing
- Both charts follow established patterns (Agg, 150 DPI, tight_layout)
- Charts auto-generate with --all flag
</success_criteria>

<output>
After completion, create `.planning/phases/08-enhanced-charts/08-01-SUMMARY.md`
</output>
